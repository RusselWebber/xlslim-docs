.. _dicts:

Passing Python dictionaries
===========================

xlSlim supports Python dictionaries. Python dictionaries returned by Python functions are automatically cached by xlSlim and a cache handle is returned to Excel. These cache handles can be supplied to any function that expects a dictionary. There is no ability to directly create a dictionary from data in Excel, dictionaries must always be created within Python functions.

.. note::
	Type hints are essential for xlSlim to determine how to handle Python dictionaries passed between your functions.

This Python module defines functions that use dictionaries to store peoples' details such as name and age. The `create_person_dict()` function creates a new dictionary with a person's details. The `describe()` function accepts a dictionary and returns a description of the person. Finally, the `average_age()` function accepts three dictionaries and returns the average age of the people contained. As usual the code has *no changes* to support xlSlim.

This example is very similar to the :ref:`objects` example. You can clearly see that although dictionaries are useful, Python classes allow for more natural functions and also allow xlSlim to handle lists of objects being passed to functions.

.. code-block:: python

	from typing import Dict


	def create_person_dict(first_name: str, last_name: str, age: int) -> Dict:
		"""Creates a new Person dictionary."""
		return {"first_name": first_name, "last_name": last_name, "age": age}


	def describe(p: Dict) -> str:
		"""Returns a string describing the person in the dictionary."""
		return f"{p.get('first_name')} {p.get('last_name')} is {p.get('age')} years old."


	def average_age(first_person: Dict, second_person: Dict, third_person: Dict) -> float:
		"""Returns the average age of three people."""
		return (
			first_person.get("age", 0)
			+ second_person.get("age", 0)
			+ third_person.get("age", 0)
		) / 3.0



.. note::
	All the Python code and Excel files shown are available from github in the `xlslim-code-samples`_ repo. I highly recommend downloading the samples from github. The Excel workbooks contain many tips and tricks.


.. _xlslim-code-samples: https://github.com/RusselWebber/xlslim-code-samples/archive/refs/heads/main.zip



Save the Python code as a new file on your PC. I saved the file in my Documents folder.

Open Excel and enter this :func:`RegisterPyModule` formula (amending the location to match where you saved the file): ::

	=RegisterPyModule("C:\Users\russe\Documents\passing_dicts.py")
	
Let's create a new person, Bob.

.. image:: ../_static/passing_dicts_create_person_with_doc.png
  :width: 400
  :alt: Create Person from Excel
 
The Python function created a new dictionary with a person's details, however a string "[Book1]Sheet1$A$3@1" was passed back to Excel. 

.. image:: ../_static/passing_dicts_create_person.png
  :width: 400
  :alt: A cache handle in Excel

What is going on?

xlSlim put the dictionary created by `create_person_dict()` into a memory cache and returned a handle to the cached item. FYI, the number after the @ increments every time the object is updated. If you repeatedly call the Excel function (use F2 on the cell or Ctrl-Alt-F9 to recalc the workbook) you will see the number increasing. This allows you to create dependencies between cells using standard Excel dependency trees.

The cache handle can be used as an input to any function that expects a dictionary. Let's call the `describe()` function.

.. image:: ../_static/passing_dicts_describe_person.png
  :width: 400
  :alt: Call function expecting dictionary in Excel

Internally xlSlim fetches the dictionary from the memory cache and passes the dictionary to the Python `describe()` function.

.. image:: ../_static/passing_dicts_describe_person_result.png
  :width: 400
  :alt: Result of call to function expecting dictionary in Excel

The function returns a string describing the person. xlSlim hid all the technical details around dictionary caching and no Python code changes were needed.

Passing multiple dictionaries
-----------------------------

Our Python module contains this `average_age()` function that expects three dictionaries with peoples' details.

.. code-block:: python

	def average_age(first_person: Dict, second_person: Dict, third_person: Dict) -> float:
		"""Returns the average age of three people."""
		return (
			first_person.get("age", 0)
			+ second_person.get("age", 0)
			+ third_person.get("age", 0)
		) / 3.0


xlSlim creates an Excel function that takes in three Python objects.

Let's create more people and calculate their average age.

.. image:: ../_static/passing_dicts_average_age.png
  :width: 400
  :alt: Function expecting three PyObjects in Excel

The average age is 30 as expected.

.. image:: ../_static/passing_dicts_average_age_result.png
  :width: 400
  :alt: Result of function call expecting three PyObjects in Excel

Viewing Python objects
----------------------

The xlSlim function :func:`ViewPyObject` can be used to view any Python object stored in the memory cache. ::

	=ViewPyObject(A5)

.. image:: ../_static/passing_dicts_view_object.png
  :width: 400
  :alt: View a cached PyObject in Excel



.. note::
	The :func:`ViewPyObject()` function can be used to view any object xlSlim has cached.

Clearing cached Python objects
------------------------------

You may need to clear cached Python objects if your Excel spreadsheet is open for a long time or creates a large number of cached objects. 

The xlSlim utility function :func:`ClearCaches` will clear all cached objects. ::

	=ClearCaches()

